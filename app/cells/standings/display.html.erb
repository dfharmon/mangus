<% user = current_user %>
<% image_url = user.avatar ? user.avatar_url.to_s : User.find_by_email('nfluser@admin.com').avatar_url.to_s %>
<div id="badge"><%= image_tag image_url %> <span class="top"><%= user.name %></span></div>

<div class='hide_on_login'>
  <div id="playoff_rules">
    <ul><span id="playoff_header">Playoffs</span>
      <li class="no_bullet">&nbsp;</li>
      <li>Bets are open from $1.00 - $4.00</li>
      <li>No max or min number of $4.00 bets</li>
    </ul>
    <br />
    <ul><span id="playoff_header">Superbowl</span>
      <li class="no_bullet">&nbsp;</li>
      <li>Mandatory $12.00 bet with option to add any amount of positive winnings (in $1.00 increments)</li>
    </ul>
  </div>

  <div id="standings_head">Overall Standings</div>
  <div class="standings">
    <table class="standings_table">
      <tr class="standings_header">
        <td class="name"></td>
        <td class="cash_head">$</td>
        <td class="percent">W/L %</td>
        <td class="wins">W</td>
        <td class="losses">L</td>
      </tr>


      <% users = {}
         User.all.each do |u|
           users[u] = u.get_results
         end
         users = users.sort_by { |k, v| v[0][0] }.reverse
         users.each do |u, results|
           cash, wins, loss = results[0].first, results[1].first, results[2].first
      %>
        <tr class="users">
          <td class="name"><%= (u.name) ? u.name : u.email %></td>
          <% style = cash >= 0 ? "cash_plus" : "cash_minus" %>
          <td class="<%= style %>"><%= sprintf "%.02f", cash %></td>
          <% wl = (number_with_precision((wins.to_f / (wins.to_f + loss.to_f)), :precision => 3)).gsub('0.', '.') %>
          <td class="percent"><%= wins.to_f + loss.to_f == 0 ? "" : wl %></td>
          <td class="wins"><%= wins %></td>
          <td class="losses"><%= loss %></td>
        </tr>
      <% end %>
    </table>
  </div>

  <div id="by_the_week">By the Week</div>
  <div>
    <% week_count = Game.current_week
       while week_count > 0
    %>

      <div class="standings">
        <table class="standings_table">
          <th id="week_count">Week <%= week_count %></th>
          <tr class="standings_header">
            <td class="name"></td>
            <td class="cash_head">$</td>
            <td class="percent">W/L %</td>
            <td class="wins">W</td>
            <td class="losses">L</td>
          </tr>

          <%
             users = users.sort_by { |k, v| v[0][week_count] }.reverse
             users.each do |u, results|
               cash, wins, loss = results[0][week_count], results[1][week_count], results[2][week_count]
          %>
            <tr class="users">
              <td class="name">
                <%= link_to_modal (u.name) ? u.name : u.email, "user_bets?user_id=#{u.id}&week=#{week_count}", class: "button", remote: true %>
                <% if week_count == Game.current_week and Game.where(final:nil, week:Game.current_week).count - u.bets.joins(:game).where(games: {week: Game.current_week, final:nil}).count > 0 %>
                  <a title='User has bets to make this week.  Go bug them.'>*</a>
                <% end %>
              </td>
              <% style = cash >= 0 ? "cash_plus" : "cash_minus" %>
              <td class="<%= style %>"><%= sprintf "%.02f", cash %></td>
              <% wl = (number_with_precision((wins.to_f / (wins.to_f + loss.to_f)), :precision => 3)).gsub('0.', '.') %>
              <td class="percent"><%= wins.to_f + loss.to_f == 0 ? "" : wl %></td>
              <td class="wins"><%= wins %></td>
              <td class="losses"><%= loss %></td>
            </tr>
          <% end %>
        </table>
      </div>
      <% week_count -= 1 %>
    <% end %>
  </div>
</div>